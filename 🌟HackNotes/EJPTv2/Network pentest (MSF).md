MSF framwork
- Robust framework for pentesters
- Automate every stage of a pen attack
- Use to create and test exploits (thus leading to a large database of publicly available exploits for use)
- New functionality is added using "modules"

There are paid versions of msf
MSF Pro/Express --> for commercial use
MSF Framework --> free, used by us

Interfacce:
- msfconsole
- MSFcli --> facilitate the creation of automation scripts that use msf modules
	-Discontinued but can still be used in the msfconsole
- MS Community edition --> web base GUI for network discovery and vuln identifying
- Armitage --> GUI for the msfconsole (same functionality but w visualisation)


## MSF Architecture

MSF Modules
Exploit -> mode to lev a vuln
Payload -> Malicious code send tru the exploit (usually a reverse shell)
Encoder ->encode payloads to prevent AV detection (eg shikata_ga_nai used for windows)
NOPS --> Ensure stability of payload when executed
Auxiliary --> Additn functions like portscanning/enumeration
![[Screenshot 2023-03-04 150008.png]]

### Payload types
Non staged
- Sent to target as is with the exploit


Staged
- Sent in 2 parts:
	1. Stager(pt1) contains a payload to establish reverse connection, download stage(pt2) and execute it
	2. Stage contains malicious code (RCE/ReverseShell/Meterpreter session)
Note: Stager is used to establish a stable connection and download the stage

### Meterpreter payload
- Advanced multi-functionla payload executed in memory making it hard to detect
- Communicates over a stager socket

### Directory
In built modules:
usr/share/metasploit-framework/modules

Own metasploit modules:
/home/kali/.msf4/modules


### Pentesting
Pentest phases
1. Information gathering
2. Enumeration
3. Exploitation
4. Post exploitation
	1. Priv Esc
	2. Maintain Persistent Access
	3. Clearing Tracks

Msf Modules for the phases
1. Auxiliary --> info gathering/Enum
2. Auxiliary/Nessus --> Vulnerbility scanner
3. Exploit Modules/Payload --> Exploitation
4. Meterpreter --> Post Exploit
5. Post exploit modules/Meterpreter --> priv esc
6.  Post exploit modules/Persistence --> Maintain persistent access

Setting up MSF....
MSF db uses PostgreSQL --> must be used for full funcitonality (ie importing scan results, exploitaiton that uses saved creds etc)

`sudo apt-get update && sudo apt-get install metasploit-framework -y`

initial setup the db
`sudo systemctl enable postgresql`
`sudo systemctl start postgresql`
`sudo systemctl status postgresql`

`sudo msfdb init`
or `sudo msfdb reinit` --> if thrs problems
`sudo msfdb status`

To start the postgresql db
`service postgresql start`
`/etc/init.d/postgresql start`

`msfconsole`  :)
```msfconsole
db_
db_status
```

### Using msfconsole
new notes:
`search cve:2009 type:exploit platform:windows` 
--> can search a cve directly and give a type of module + platform

works just like nc -lvnp 80
`connect -h`
`connect 192.168.2.3 80` 

### MSF workspaces
datastored for different pentesting engagements
- the database makes sure data is not lost between startups
- But data shud not be shared between 2 diff projects --> Thus workspaces exist to seperate

`db satus`
`workspace` --> workspace being used
`hosts` --> lists out details of all hosts prev found in engagement

`workspace -a test`
`workspace -d test`
--> adds/deletes a new workspace 'test'
then check current workspace using `workspace`, shud be in test
`hosts` --> no longer shows prev data

`workspace default`
--> shifts back to default workspace with all the prev data

## Nmap with MSFconsole

- Output scan for MSFdb (into xml format)
-oX `output file name`
Eg `nmap -Pn -sV -O 10.4.22.173 -oX windows_server_2012.xml`

- Import nmap scan data
In MSFconsole 
`workspace -a win2k12`
`db_import /windows_server_2012.xml`

- MSFconsole can also do a nmap scan
`db_nmap -Pn -sV -O 10.4.22.173`  

Useful xtra functions:
`hosts` --> to double check the scan for the host was added
`services`  --> shows the services prev scanned
`vulns` --> lists out available vulns ???


## MSF enumeration

Portscanning with auxiliary enumeration
- use to extract info from target
- Services to enumerate: FTP, SMB, SSH, HTTP
- Most useful for post exploit, after initial access (ie u cant/shud not import nmap onto the target)

### Portscanning
- Search for appropriate scanner `search portscan`
- set options
- run (open ports show up )
- `curl <target ip>` dwnlds the webapp display if you dont have access to the browser and port 80 is open

ontarget session
- shell
- `/bin/bash -i`  open a bash terminal to make it easier to type cmds
- `ifconfig` --> find an interface under a diff subnet from the one u accessed the targt from
- From thr just pingsweep the new subnet (or assume its on .3 instead of .2 etc)

Route the new subnet
`run autoroute -s 192.113.124.2 ` 
--> just add a ip addr from the subnet (dont need the actual ip of the new target or the subnet range)

Portscan the new ip using the portscan/tcp module or /udp also works

### FTP enumeration
auxiliary module used
/ftp/ftp_version
/ftp/anonymous

/ftp/ftp_login
--> set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
--> set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt

from the msfconsole connect directly to ftp
`ftp <target ip>  `
--> enter username/pword

### SMB enum
- shared central storage allowing read and write directly on the server
(unlike FTP where you r only allowed to make a copy from the server, but FTP is faster at sending out files)

auxiliary module used
/smb/smb_version
/smb/smb_enumusers

/smb/smb_enumshares
`set ShowFiles true` 
->shows shares for the specific users (might not be same as users)

/smb/smb_login
`set SMBUser admin` (Or watever is needed)
`set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt`

List out shares
`smbclient -L \\\\192.91.46.3\\ -U admin`

Login
`smbclient \\\\192.91.46.3\\<sharename> -U admin`


### Web server enum
- web server utilises HTTP (80) HTTPS(430)

auxiliary module used
/http/http_version
--> if SSL used (ie HTTPS) set SSL true

/http/http_header
--> can either use HEAD or GET
--> ign_header is a list of headers to ignore
- The Content-Type gives clue on the language used on the server

/http/robots_txt
--> scan for the robots.txt (file that exclude certain directories from being crawled)
--> curl the directories excluded found in robots.txt exists for more info
`curl http://<ip>/<dir found>/`

Directory listing found
- Native to apache and some web servers
- Allows to store files in some dirs

Secure dir found
- Needs auth/ can try bruteforcing creds

/http/dir_scanner
--> dirb basically

/http/files_dir
--> bruteforce to find files HTTP file scanner
--> can change the dict to anyt u want from /usr/share/wordlists

/http/http_login
--> auth bf for http
`set AUTH_URI /<watever dir needs auth>/
`unset USERPASS_FILE` --> in this case, the user file and pass file alrdy set, so dont need userpass
Try other wordlists
`set USER_FILE /usr/share/metasploit-framework/data/wordlists/namelist.txt`
`set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt`

/http/apache_userdir_enum
--> identifies valid users on the server based on the error code returned
--> use this to find valid users then bf with a pw wordlist
`set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt`
Note: In the example user `rooty` was found
- Use that username for the http_login module 

### MySQL Enum
- Used to store data -p3306 (port can be anyt)
- commonly deployed for web app data

auxiliary module used
search type:auxiliary name:mysql

/scanner/portscan/tcp  --> find the port mysql is hosted on

/mysql/mysql_version

/mysql/mysql_login
`set USERNAME root`
`set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt`

/admin/mysql/mysql_enum
--> credentials required to use mods in admin subdir
`set <username/password options>`

/admin/mysql/mysql_sql
--> interact with the db using commands
Eg `set SQL show databases;`

/mysql/mysql_schemadump

Useful commands in msfconsole:
`loot` to see info u found
`creds` dumps out all the creds found
`services` dumps out services scanned
--> creating a workspace for every assesment makes this convenient

#### Enum MySQL normally
`mysql -h 192.146.6.3 -u root -p <watever>`
`show databases`
`use <database>`
`show tables` etc etc

### SSH Enum
-p22
- for remote access with a GUI use RDP or VNC etc instead
- adv over telnet is encryption (Prevent MIMs)

auxiliary modules used
Note: `setg RHOST` and `setg RHOSTS` -->mods could use either

`search type:auxiliary name:ssh`

/ssh/ssh_version

/ssh/ssh_login
--> if target is not config to use public key encryt else use below mod instead
--> session starts up auto
`set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt`
`set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt`

/ssh/ssh_login_pubkey

/ssh/ssh_enumusers
--> narrow down the bruteforce 

### SMTP Enum
- simple mail transfer protocol
- for email transmission
-p25 defualt
-p465/587 with encrytion (SSL or TLS cert is set up)

auxiliary modules used
`search type:auxiliary name:smtp`

/smtp/smtp_version
--> gives the version (eg ESMTP Postfix)
--> also gives email domain format for this server (eg openmailbox.xyz)

/smtp/smtp_enum
`set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_users.txt`




## Vulnerability Scanning
- Scan for vulnerabilitys and see if it can exploited
- Find msf modules to exploit

Lab demo:
- Using Metasploitable3 a vuln virtual machine

find the target on the network
`sudo nmap -sn 10.10.10.1/24` 

In msfconsole
`workspace -a <name this>`
`db_nmap -sS -sV -O 10.10.10.4`

--> lots of services apear
--> the smb port give an idea of the OS running

Find exploits
--> go tru the services and
`search type:exploit name:<servicename>`
- If no exploits found means 
	1. There are no epxloits or
	2. No MSF exploits exist for it (eternal/manual exploit needed)
- If exploit is found
	-> `use` and `info` the mod to see if can

--> rmb to set payload to correct OS
`set payload windows/meterpreter/reverse_tcp`

`services` --> check the port to use for exploit found from scan

Find exploits using `searchsploit`
-> Finds vulns from ExploitDB
-> Find MSF exploit modules for them
`searchsploit "Microsoft Windows SMB" | grep -e "metasploit"` 

#### Metasploit-autopwn
- works with the database (Must start postgre) to find vulns
- clone the rept and move it to the msf plugins dir
`wget https://raw.githubusercontent.com/hahwul/metasploit-autopwn/master/db_autopwn.rb`
`cp db_autopwn.rb /usr/share/metasploit-framework/plugins'

In msfconsole
`load db_autopwn` --> load the plugin
`db_autopwn`

`db_autopwn -p -t -PI 21` etc

#### Analyse command
- uses the scan info in the database to find vulns
- set the target then
`analyse`
--> the vulns get listed out

`vulns` --> should now show the vulnerabilities found for that target